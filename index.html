<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Meet-Style + Teachable Machine Preview (mini)</title>
  <!-- ëª¨ë°”ì¼ ê¶Œí•œ íŒíŠ¸ -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- p5.js (ml5ì˜ ì¼ë¶€ ì˜ˆì œë“¤ì´ p5ì— ì˜ì¡´) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.5.0/p5.min.js"></script>
  <!-- tfjs & ml5 -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
  <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>

  <style>
    :root{
      --bg:#0b0f14; --panel:#121820; --card:#1b2430; --text:#e9eef5; --muted:#9fb3c8; --accent:#5b9bff;
      --danger:#ff4d4f; --ok:#28c76f;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(135deg,#0b0f14,#121820);color:var(--text);font-family:Inter,system-ui,Segoe UI,Apple SD Gothic Neo,AppleGothic,Arial,sans-serif}
    .meet {
      display:grid; grid-template-rows:auto 1fr auto; height:100dvh; width:100%;
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 16px; background:rgba(0,0,0,0.35); backdrop-filter: blur(6px); border-bottom:1px solid rgba(255,255,255,0.08);
    }
    .topbar .left{display:flex; gap:10px; align-items:center}
    .badge{background:rgba(255,255,255,0.08); padding:6px 10px; border-radius:12px; font-size:12px; color:var(--muted)}
    .room { font-weight:600; letter-spacing:.3px}
    .main{
      position:relative; display:grid; grid-template-columns: 1fr 320px; gap:14px; padding:14px;
    }
    .videoStage{
      position:relative; border-radius:18px; background: #000; box-shadow: 0 10px 30px rgba(0,0,0,0.35); overflow:hidden;
      display:flex; align-items:center; justify-content:center;
    }
    .fakeVideo{
      width:100%; height:100%; background:
        radial-gradient(1200px 600px at 40% 30%, #1e293b 0%, #0b0f14 60%),
        url('https://images.unsplash.com/photo-1544198365-8892eb97de7e?q=80&w=1400&auto=format&fit=crop') center/cover no-repeat;
      filter: saturate(1.05) contrast(1.05) brightness(0.9);
    }
    .sidebar{
      border-radius:18px; background:var(--panel); border:1px solid rgba(255,255,255,0.08); overflow:hidden;
      display:flex; flex-direction:column;
    }
    .sidebar h3{margin:14px 14px 0 14px; font-size:14px; color:#c8d7ea; opacity:.9}
    .chat{
      padding:12px 14px; flex:1; overflow:auto; color:var(--muted); font-size:14px;
    }
    .bottombar{
      display:flex; align-items:center; justify-content:center; gap:10px; padding:14px;
    }
    .ctrl{
      display:flex; align-items:center; gap:10px; background:rgba(0,0,0,0.35); border:1px solid rgba(255,255,255,0.08);
      padding:8px 10px; border-radius:40px;
    }
    .btn{
      border:none; color:var(--text); background:var(--card); padding:10px 14px; border-radius:18px; cursor:pointer; font-weight:600;
      border:1px solid rgba(255,255,255,0.08);
    }
    .btn:hover{filter:brightness(1.08)}
    .btn.danger{background:#2a1414; border-color:#3d1a1a; color:#ffb3b3}
    /* ğŸ”¹ TM ë¯¸ë‹ˆ ìœ„ì ¯ (Meet ìš°í•˜ë‹¨ PiP ëŠë‚Œ) */
    .tm-mini{
      position:absolute; right:14px; bottom:14px; width:300px; background:var(--card);
      border:1px solid rgba(255,255,255,0.12); border-radius:16px; box-shadow: 0 8px 24px rgba(0,0,0,0.45);
      overflow:hidden; z-index:10;
    }
    .tm-head{
      display:flex; align-items:center; justify-content:space-between; padding:8px 10px; background:rgba(0,0,0,0.3);
      border-bottom:1px solid rgba(255,255,255,0.08);
    }
    .tm-head b{font-size:13px}
    .tm-body{padding:10px; max-height:220px; overflow:auto}
    .bar{
      height:8px; background:rgba(255,255,255,0.1); border-radius:6px; overflow:hidden;
    }
    .bar > span{
      display:block; height:100%; width:0%;
      background:linear-gradient(90deg,var(--accent),#72ffa5);
      transition: width .3s ease;
    }
    .row{display:grid; grid-template-columns: 1fr 48px; gap:8px; align-items:center; margin:10px 0}
    .row label{font-size:13px; color:#cfe0f5}
    .row .pct{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; color:#a8c3e8; text-align:right}
    .tm-foot{
      display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 10px; border-top:1px solid rgba(255,255,255,0.08);
      background:rgba(0,0,0,0.25); font-size:12px; color:var(--muted)
    }
    .dot{width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:6px; background:var(--danger)}
    .dot.on{background:var(--ok)}
    /* ìŠ¤í¬ë¡¤ ìŠ¤íƒ€ì¼ */
    ::-webkit-scrollbar{height:10px;width:10px}
    ::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.16); border-radius:20px}
    ::-webkit-scrollbar-track{background:transparent}
    @media (max-width: 900px){
      .main{grid-template-columns: 1fr}
      .sidebar{display:none}
    }
  </style>
</head>
<body>
  <div class="meet">
    <!-- ìƒë‹¨ ë°” -->
    <div class="topbar">
      <div class="left">
        <span class="badge">ğŸ”’ ë³´í˜¸ëœ íšŒì˜</span>
        <span class="room">íšŒì˜: demo-room</span>
      </div>
      <div class="right">
        <span class="badge">ë¯¸ë¦¬ë³´ê¸°</span>
      </div>
    </div>

    <!-- ë©”ì¸ -->
    <div class="main">
      <div class="videoStage">
        <!-- ì—¬ê¸°ì— ì‹¤ì œ WebRTC ë¹„ë””ì˜¤ ë¶™ì—¬ë„ ë¨. ì§€ê¸ˆì€ í”„ë¦¬ë·° ë°°ê²½ -->
        <div class="fakeVideo" aria-label="Video stage placeholder"></div>

        <!-- ğŸ”¹ TM ë¯¸ë‹ˆ ìœ„ì ¯ -->
        <div class="tm-mini" id="tmBox">
          <div class="tm-head">
            <b>Teachable Machine â€” Live Preview</b>
            <button class="btn" id="toggleMic">ğŸ™ï¸ ë§ˆì´í¬ ì¼œê¸°</button>
          </div>
          <div class="tm-body" id="tmBody">
            <div style="color:#9fb3c8; font-size:13px; line-height:1.4">
              ë§ˆì´í¬ë¥¼ ì¼œë©´ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¶„ë¥˜ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.<br/>
              (ë¸Œë¼ìš°ì € ê¶Œí•œ í—ˆìš© í•„ìš”)
            </div>
          </div>
          <div class="tm-foot">
            <div><span class="dot" id="micDot"></span><span id="micLabel">ë§ˆì´í¬ êº¼ì§</span></div>
            <div id="modelStatus">ëª¨ë¸: ë¡œë“œ ëŒ€ê¸°</div>
          </div>
        </div>
      </div>

      <!-- ìš°ì¸¡ ì‚¬ì´ë“œ(ì±„íŒ…Â·ì •ë³´) -->
      <aside class="sidebar">
        <h3>íšŒì˜ ì •ë³´</h3>
        <div class="chat">
          <p>ì´ íŒ¨ë„ì€ ì±„íŒ…/ì°¸ê°€ì/ë…¸íŠ¸ ë“±ìœ¼ë¡œ ììœ  êµ¬ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
          <p>ì˜¤ë¥¸ìª½ ì•„ë˜ì— TM ë¯¸ë‹ˆ í”„ë¦¬ë·°ê°€ êµ¬ê¸€ ë¯¸íŠ¸ì˜ PiPì²˜ëŸ¼ ëœ¨ê²Œ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.</p>
        </div>
      </aside>
    </div>

    <!-- í•˜ë‹¨ ì»¨íŠ¸ë¡¤ ë°” -->
    <div class="bottombar">
      <div class="ctrl">
        <button class="btn">ğŸ¥ ì¹´ë©”ë¼</button>
        <button class="btn">ğŸ¤ ìŒì†Œê±°</button>
        <button class="btn danger">ğŸ”š ë‚˜ê°€ê¸°</button>
      </div>
    </div>
  </div>

  <script>
    // ====== ì„¤ì • ======
    // ğŸ”— ë‹¹ì‹ ì´ ì¤€ ëª¨ë¸ ID: gSHOySjax (Audio í”„ë¡œì íŠ¸ë¼ê³  ê°€ì •)
    const MODEL_DIR = "https://teachablemachine.withgoogle.com/models/gSHOySjax/";
    // ===================

    let classifier = null;
    let micOn = false;
    let running = false;
    let labelEls = [];   // {row, bar, pct}
    let lastResult = [];

    const tmBody = document.getElementById("tmBody");
    const micDot = document.getElementById("micDot");
    const micLabel = document.getElementById("micLabel");
    const modelStatus = document.getElementById("modelStatus");
    const toggleMicBtn = document.getElementById("toggleMic");

    // ëª¨ë¸ ë¡œë“œ
    async function loadModel() {
      modelStatus.textContent = "ëª¨ë¸: ë¡œë”© ì¤‘...";
      try {
        // Teachable Machine Audio ëª¨ë¸ì€ soundClassifier ì‚¬ìš©
        classifier = await ml5.soundClassifier(MODEL_DIR + "model.json", { probabilityThreshold: 0.0 });
        modelStatus.textContent = "ëª¨ë¸: ë¡œë“œ ì™„ë£Œ";
        // í´ë˜ìŠ¤(ë ˆì´ë¸”) ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        const labels = (classifier && classifier.model && classifier.model.model && classifier.model.model.metadata && classifier.model.model.metadata.labels)
          ? classifier.model.model.metadata.labels
          : null;

        if (!labels) {
          // ml5ê°€ ë©”íƒ€ë°ì´í„° ê²½ë¡œê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì˜ˆì¸¡ í•œ ë²ˆ í˜¸ì¶œ í›„ ë™ì ìœ¼ë¡œ ê·¸ë¦¬ê¸°
          buildRows(["class_1","class_2","class_3","..."]);
        } else {
          buildRows(labels);
        }
      } catch (err) {
        console.error(err);
        modelStatus.textContent = "ëª¨ë¸: ë¡œë“œ ì‹¤íŒ¨";
        tmBody.innerHTML = `<div style="color:#ffb3b3">ëª¨ë¸ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. URLì„ í™•ì¸í•˜ì„¸ìš”.<br/>(${MODEL_DIR}model.json)</div>`;
      }
    }

    function buildRows(labels) {
      tmBody.innerHTML = "";
      labelEls = [];
      labels.forEach(lab => {
        const row = document.createElement("div");
        row.className = "row";
        const label = document.createElement("label");
        label.textContent = lab;
        const pct = document.createElement("div");
        pct.className = "pct";
        pct.textContent = "0.00";
        const barWrap = document.createElement("div");
        barWrap.className = "bar";
        const bar = document.createElement("span");
        barWrap.appendChild(bar);
        row.appendChild(label);
        row.appendChild(pct);
        const full = document.createElement("div");
        full.style.gridColumn = "1 / span 2";
        full.appendChild(barWrap);
        tmBody.appendChild(row);
        tmBody.appendChild(full);
        labelEls.push({label, pct, bar});
      });
    }

    // ë¶„ë¥˜ ì½œë°±
    function gotResult(err, results) {
      if (err) { console.error(err); return; }
      lastResult = results;
      // results: [{label, confidence}, ...]
      // label ëª©ë¡ì´ ì‚¬ì „ì— ì—†ìœ¼ë©´ ë™ì ìœ¼ë¡œ UI ì¬êµ¬ì„±
      if (labelEls.length !== results.length) {
        buildRows(results.map(r => r.label));
      }
      // ë§‰ëŒ€ ì—…ë°ì´íŠ¸
      results.forEach((r, i) => {
        const p = Math.max(0, Math.min(1, r.confidence || 0)); // 0~1
        labelEls[i].pct.textContent = (p * 100).toFixed(2) + "%";
        labelEls[i].bar.style.width = (p * 100) + "%";
      });
    }

    async function startClassify() {
      if (!classifier || running) return;
      running = true;
      try {
        // classify ì‹œì‘
        classifier.classify(gotResult);
      } catch (e) {
        console.error("classify í˜¸ì¶œ ì‹¤íŒ¨:", e);
        running = false;
        tmBody.insertAdjacentHTML("afterbegin",
          `<div style="color:#ffb3b3;margin-bottom:6px">classify()ë¥¼ í˜¸ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. 
           ëª¨ë¸ íƒ€ì…(ì˜¤ë””ì˜¤/ì´ë¯¸ì§€)ì„ í™•ì¸í•˜ì„¸ìš”.</div>`);
      }
    }

    function setMicState(on) {
      micOn = on;
      micDot.classList.toggle("on", on);
      micLabel.textContent = on ? "ë§ˆì´í¬ ì¼œì§" : "ë§ˆì´í¬ êº¼ì§";
      toggleMicBtn.textContent = on ? "ğŸ›‘ ë§ˆì´í¬ ë„ê¸°" : "ğŸ™ï¸ ë§ˆì´í¬ ì¼œê¸°";
    }

    toggleMicBtn.addEventListener("click", async () => {
      if (!classifier) {
        await loadModel();
      }
      if (!micOn) {
        // ì‚¬ìš© ê¶Œí•œ ìš”ì²­(ì˜¤ë””ì˜¤)
        try {
          await navigator.mediaDevices.getUserMedia({audio:true});
          setMicState(true);
          await startClassify();
        } catch (e) {
          console.error(e);
          alert("ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì•¼ í•©ë‹ˆë‹¤.");
        }
      } else {
        // ml5.soundClassifierëŠ” ë‚´ë¶€ì—ì„œ ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ì„ ê´€ë¦¬í•˜ë¯€ë¡œ,
        // ê°„ë‹¨íˆ í˜ì´ì§€ ë¦¬ë¡œë“œ/í† ê¸€ ë©”ì‹œì§€ë¡œ ëŒ€ì²´ (ì •êµ ì œì–´ê°€ í•„ìš”í•˜ë©´ ë³„ë„ êµ¬í˜„)
        setMicState(false);
        location.reload();
      }
    });

    // ì²« ì§„ì…ì‹œ ë¯¸ë¦¬ ëª¨ë¸ ë¡œë“œ ì‹œë„(ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ë’¤ ê¶Œí•œ í—ˆìš© í•„ìš”)
    loadModel();
  </script>
</body>
</html>
